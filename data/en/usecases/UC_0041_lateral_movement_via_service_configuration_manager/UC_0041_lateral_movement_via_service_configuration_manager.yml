title: 'Lateral movement via Service Configuration Manager'
id: UC0041
author: 'Alex@Cyberok'
creation_date: 2023/02/28
modification_date: 2023/02/28
severity: M
tags:
  - lateral_movement
  - attack.t1021
  - persistense
  - attack.t1543
  - windows
linked_response_playbooks:
  - RP3004
linked_artifacts:
  - A3002
  - A5006
  - A5012
  - A5010
  - A5011
description: Execute commands on a remote host by abusing service configuration manager by changing the service binpath.
extended_description: |
    
    It's possible to execute commands on a [remote host]() by abusing [service configuration manager]() by changing the [service]() binpath to your malicious command and restarting the service so your payload gets executed - this is all automated by a nice tool [SCShell](https://github.com/Mr-Un1k0d3r/SCShell).
    
    The utility can be used remotely *WITHOUT* registering a service or creating a service. It also doesn't have to drop any [file]() on the remote system* (Depend on the technique used to execute), so SCShell is a fileless lateral movement that relies on ChangeServiceConfigA to run commands. It does not perform [authentication against SMB](https://learn.microsoft.com/en-us/windows/win32/fileio/microsoft-smb-protocol-authentication), everything is performed over [DCERPC](http://www.dcerpc.org/).
    
    ## Attack mapping
    
    | ARTIFACT                                                                        | OBJECT                   | DESCRIPTION                                                                               |
    |---------------------------------------------------------------------------------|--------------------------|-------------------------------------------------------------------------------------------|
    |  **Attack Prerequisites**                                                       |
    | [Credentials](/artifacts/A_5006_credential/entity)                              | User's credentials (login and password) | It's used as arguments for lateral movent actions    |
    | [Remote Procedure Call](/artifacts/A_5012_remote_procedure_call/entity/)        | RPC                      | SCShell utilizes authentication over DCERPC  |
    | [File](/artifacts/A_3002_file/entity/)                                          | SCShell or other similar tool | Fileless lateral movement tool  |
    | **Side Observables**                                                            |
    | [RPC Network Traffic](/artifacts/A_5011_RPC_network_traffic/entity/)            | Generated network traffic  | Network traffic generated by using SCShell DCERPC module |
    | [Service Application](/artifacts/A_5010_service_application/entity/)            | Victim service          | Service which is used for abuse and changing binpath |
    
    ## Attack results
    
    Successfull attack allows to execute commands on the [remote host](). 
    
    | RESOURCE                                                              | DESCRIPTION                                                                               |
    |-----------------------------------------------------------------------|-------------------------------------------------------------------------------------------|
    | **Attack Prerequisites**                                              |                                                                                           |
    | [Privileged Access]()                                                 | Compromised host with privileged access |
    | [Credential Access]()                                                 | Any user's credentials |
    | **Result Consequences**                                               |                                                                                           |
    | [Remote Code Execution]()                                             | Attacker gets an ability to execute commands on the remote host |

    ## Attack progress
    1) Scshell expects the following arguments: target, service, payload, username, domain, password:
    ```
    .\scshell.exe ws01 XblAuthManager "C:\windows\system32\cmd.exe /c echo 'lateral hello' > c:\temp\lat.txt" username domain password
    ```
    ![SCshell](20.gif)
    
    2) From the defensive side, you may want to consider about monitoring services that change their binPaths "too often" as this may not be normal in your environment, especially if the binPath is "very" [different](https://en.wikipedia.org/wiki/Levenshtein_distance "Levenshtein") to the previously known good value and if the service configuration is being changed over the network:
    ![Example](28.JPG)

    ## Attack diagram
    ![Diagram](32.svg)
    
    ## References 
    
    [SCShell Fileless lateral movement](https://github.com/Mr-Un1k0d3r/SCShell)
    
    